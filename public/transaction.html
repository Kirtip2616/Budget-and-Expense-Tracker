<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <script src="theme.js"></script>
  <script>
    window.onload = function () {
      const tableBody = document.querySelector('.transaction-table tbody');
      const addBtn = document.querySelector('.view-btn');
      const exportBtn = document.querySelector('.export-btn');
      const customAlert = document.querySelector('#customAlert');
      const alertMessage = document.querySelector('#alertMessage');
      const confirmAlertBtn = document.querySelector('#confirmAlert');
      const cancelAlertBtn = document.querySelector('#cancelAlert');
      const profileIcon = document.getElementById('profileIcon');
      const profileDropdown = document.getElementById('profileDropdown');
      const darkModeToggle = document.getElementById('darkModeToggle');
      const logoutBtn = document.getElementById('logoutBtn');
      let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
      let deleteIndex = null;

      // Profile menu functionality
      profileIcon.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        profileDropdown.classList.toggle('show');
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!profileIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
          profileDropdown.classList.remove('show');
        }
      });

      // Dark mode toggle
      darkModeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      });

      // Logout functionality
      logoutBtn.addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      function showCustomAlert(message, onConfirm) {
        alertMessage.textContent = message;
        customAlert.classList.add('show');
        confirmAlertBtn.onclick = () => {
          onConfirm();
          customAlert.classList.remove('show');
        };
        cancelAlertBtn.onclick = () => {
          customAlert.classList.remove('show');
          deleteIndex = null;
        };
      }

      function renderTransactions() {
        tableBody.innerHTML = '';
        transactions.forEach((t, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${t.category}</td>
            <td>${t.description}</td>
            <td>${t.date}</td>
            <td><span class="badge ${t.type.toLowerCase()} toggle-type" data-index="${index}">${t.type}</span></td>
            <td>₹${parseFloat(t.amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>
              <button class="delete-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
            </td>
          `;
          tableBody.appendChild(row);
        });
        enableToggle();
        enableDelete();
      }

      function enableToggle() {
        document.querySelectorAll('.toggle-type').forEach(span => {
          span.onclick = () => {
            const index = span.getAttribute('data-index');
            transactions[index].type = transactions[index].type === 'Income' ? 'Expense' : 'Income';
            localStorage.setItem('transactions', JSON.stringify(transactions));
            renderTransactions();
            window.dispatchEvent(new StorageEvent('storage', {
              key: 'transactions',
              newValue: JSON.stringify(transactions),
              storageArea: localStorage
            }));
          };
        });
      }

      function enableDelete() {
        document.querySelectorAll('.delete-btn').forEach(button => {
          button.onclick = () => {
            deleteIndex = button.getAttribute('data-index');
            showCustomAlert('Are you sure you want to delete this transaction?', () => {
              if (deleteIndex !== null) {
                transactions.splice(deleteIndex, 1);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderTransactions();
                window.dispatchEvent(new StorageEvent('storage', {
                  key: 'transactions',
                  newValue: JSON.stringify(transactions),
                  storageArea: localStorage
                }));
                deleteIndex = null;
              }
            });
          };
        });
      }

      // Close modal if user clicks outside of it
      window.onclick = function(event) {
        if (event.target === customAlert) {
          customAlert.classList.remove('show');
          deleteIndex = null;
        }
      };

      function exportToCSV() {
        const headers = ['Category', 'Description', 'Date', 'Type', 'Amount'];
        const csvContent = [
          headers.join(','),
          ...transactions.map(t => [
            t.category,
            t.description,
            t.date,
            t.type,
            t.amount
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'transactions.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      addBtn.addEventListener('click', () => {
        const inputRow = document.createElement('tr');
        inputRow.innerHTML = `
          <td><input type="text" placeholder="Category" /></td>
          <td><input type="text" placeholder="Description" /></td>
          <td><input type="date" /></td>
          <td>
            <select>
              <option>Income</option>
              <option>Expense</option>
            </select>
          </td>
          <td><input type="number" step="0.01" placeholder="Amount" /></td>
          <td><button class="save-row">✔️</button></td>
        `;
        tableBody.appendChild(inputRow);

        inputRow.querySelector('.save-row').addEventListener('click', () => {
          const inputs = inputRow.querySelectorAll('input, select');
          if (!inputs[0].value || !inputs[1].value || !inputs[2].value || !inputs[4].value) {
            alert('Please fill out all fields.');
            return;
          }

          const newTransaction = {
            category: inputs[0].value,
            description: inputs[1].value,
            date: inputs[2].value,
            type: inputs[3].value,
            amount: inputs[4].value
          };
          transactions.push(newTransaction);
          localStorage.setItem('transactions', JSON.stringify(transactions));
          renderTransactions();
          window.dispatchEvent(new StorageEvent('storage', {
            key: 'transactions',
            newValue: JSON.stringify(transactions),
            storageArea: localStorage
          }));
        });
      });

      exportBtn.addEventListener('click', exportToCSV);

      renderTransactions();
    };
  </script>
</head>
<body>
  <div class="container">
    <!-- Sidebar (same as your budget.html) -->
    <div class="sidebar">
      <div class="logo">
        <img src="logoo.png" alt="Logo">
        <span>BudgetTracker</span>
      </div>
      <nav>
        <ul>
          <li><a href="main.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="budget.html"><i class="fas fa-piggy-bank"></i> Budgets</a></li>
          <li><a href="expense.html" class=""><i class="fas fa-file-invoice-dollar"></i> Expenses</a></li>
          <li><a href="transaction.html" class="active"><i class="fas fa-arrow-up"></i> Transactions</a></li>
        </ul>
      </nav>
    </div>
    <section class="transaction-history">
      <div class="transaction-header">
        <h2>Transaction history</h2>
        <div class="transaction-actions">
          <div class="profile-menu">
            <div class="profile-icon" id="profileIcon">
              <!-- <i class="fas fa-user-circle"></i> -->
            </div>
            <div class="profile-dropdown" id="profileDropdown">
              <div class="dropdown-item" id="darkModeToggle">
                <i class="fas fa-moon"></i>
                <span>Dark Mode</span>
              </div>
              <div class="dropdown-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </div>
            </div>
          </div>
          <button class="export-btn">Export CSV</button>
          <button class="view-btn">Add</button>
        </div>
      </div>
      <table class="transaction-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Description</th>
            <th>Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <!-- Custom Alert Modal -->
      <div id="customAlert" class="custom-alert">
        <div class="custom-alert-content">
          <p id="alertMessage"></p>
          <div class="custom-alert-buttons">
            <button id="confirmAlert" class="custom-alert-btn custom-alert-ok">Yes</button>
            <button id="cancelAlert" class="custom-alert-btn custom-alert-cancel">Cancel</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</body>
</html>